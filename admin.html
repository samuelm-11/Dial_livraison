<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />
    <link rel="stylesheet" href="./styles.css" />
  </head>

  <body>
    <header class="topbar">
      <div class="brand">Livraison</div>
      <div class="muted">Admin</div>
      <div style="flex:1"></div>
      <button id="logoutBtn">Déconnexion</button>
    </header>

    <main class="container" style="max-width: 1000px;">
      <div class="card">
        <div style="display:flex; align-items:center; gap:10px;">
          <h2 style="margin:0;">Admin</h2>
          <div id="who" class="muted" style="font-size:12px;"></div>
          <div style="flex:1"></div>
          <button id="reloadBtn" class="smallbtn" type="button">↻ Recharger</button>
        </div>

        <div class="muted" style="font-size:12px; margin-top:8px;">
          Les pins viennent de la table <b>locations</b>.
        </div>

        <div id="err" class="err" style="margin-top:10px;"></div>

        <!-- Carte -->
        <div id="map" style="height: 520px; margin-top: 12px; border-radius: 12px; overflow:hidden;"></div>
      </div>
    </main>

    <!-- ✅ 1) LE DIALOG = HTML (donc ici, dans le body, hors script) -->
    <dialog id="addDialog">
      <form id="addForm" class="grid" style="margin:0;">
        <h3 style="margin:0 0 6px 0;">Nouveau lieu</h3>
        <div class="muted" style="font-size:12px;">Coordonnées : <span id="coordsText">—</span></div>

        <label class="field">
          <div class="label">Nom</div>
          <input id="fName" required placeholder="Ex: Machine sandwich Avia Partner" />
        </label>

        <label class="field">
          <div class="label">Type</div>
          <select id="fType">
            <option value="sandwich">sandwich</option>
            <option value="snack">snack</option>
            <option value="autre">autre</option>
          </select>
        </label>

        <label class="field">
          <div class="label">Site</div>
          <input id="fSite" placeholder="Ex: Aéroport LGG / Avia" />
        </label>

        <label class="field">
          <div class="label">Notes</div>
          <textarea id="fNotes" placeholder="Badge, accès, horaires…"></textarea>
        </label>

        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
          <button id="cancelBtn" type="button" class="smallbtn">Annuler</button>
          <button type="submit" class="smallbtn">Enregistrer</button>
        </div>
      </form>
    </dialog>

    <!-- Config -->
    <script src="./config.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <script type="module">
      // -----------------------------
      // Helpers UI
      // -----------------------------
      const errBox = document.getElementById("err");
      const whoBox = document.getElementById("who");
      const reloadBtn = document.getElementById("reloadBtn");

      function setErr(msg) {
        errBox.textContent = msg || "";
      }

      // -----------------------------
      // Init Supabase
      // -----------------------------
      const supabase = window.supabase.createClient(
        window.APP_CONFIG.SUPABASE_URL,
        window.APP_CONFIG.SUPABASE_ANON_KEY
      );

      // -----------------------------
      // Auth guard
      // -----------------------------
      const { data: auth } = await supabase.auth.getUser();
      if (!auth?.user) {
        window.location.href = "./index.html";
      } else {
        whoBox.textContent = auth.user.email ? `Connecté : ${auth.user.email}` : "";
      }

      const { data: profile, error: profileErr } = await supabase
        .from("profiles")
        .select("role")
        .eq("user_id", auth.user.id)
        .single();

      if (profileErr) {
        setErr("Erreur profile: " + profileErr.message);
      } else if (profile?.role !== "admin") {
        window.location.href = "./driver.html";
      }

      // -----------------------------
      // Logout
      // -----------------------------
      document.getElementById("logoutBtn").onclick = async () => {
        await supabase.auth.signOut();
        window.location.href = "./index.html";
      };

      // -----------------------------
      // Leaflet map
      // -----------------------------
      const map = L.map("map").setView([50.631, 5.571], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      // -----------------------------
      // Markers rendering
      // -----------------------------
      let markers = [];

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function renderLocations(locations) {
        markers.forEach((m) => map.removeLayer(m));
        markers = [];

        locations.forEach((loc) => {
          if (loc.latitude == null || loc.longitude == null) return;

          const marker = L.marker([loc.latitude, loc.longitude]).addTo(map);
          marker.bindPopup(`
            <div style="font-weight:900;">${escapeHtml(loc.name || "")}</div>
            <div style="opacity:.75; font-size:12px;">
              ${escapeHtml(loc.type || "")} ${loc.site ? "— " + escapeHtml(loc.site) : ""}
            </div>
          `);

          markers.push(marker);
        });
      }

      // -----------------------------
      // Load locations
      // -----------------------------
      async function loadLocations() {
        setErr("");
        const { data, error } = await supabase
          .from("locations")
          .select("*")
          .order("created_at", { ascending: false });

        if (error) {
          console.error(error);
          setErr("Erreur chargement locations: " + error.message);
          return;
        }

        renderLocations(data || []);
      }

      reloadBtn.onclick = loadLocations;

      // -----------------------------
      // ✅ Ajout via Dialog (pas de prompt)
      // -----------------------------
      const addDialog = document.getElementById("addDialog");
      const addForm = document.getElementById("addForm");
      const cancelBtn = document.getElementById("cancelBtn");

      const fName = document.getElementById("fName");
      const fType = document.getElementById("fType");
      const fSite = document.getElementById("fSite");
      const fNotes = document.getElementById("fNotes");
      const coordsText = document.getElementById("coordsText");

      let pendingLatLng = null;

      cancelBtn.onclick = () => addDialog.close();

      map.on("click", (e) => {
        // évite d’ouvrir quand on clique un marker
        if (e.originalEvent?.target?.closest?.(".leaflet-marker-icon")) return;

        pendingLatLng = e.latlng;
        coordsText.textContent = `${pendingLatLng.lat.toFixed(6)}, ${pendingLatLng.lng.toFixed(6)}`;

        // reset champs
        fName.value = "";
        fType.value = "sandwich";
        fSite.value = "";
        fNotes.value = "";

        addDialog.showModal();
        fName.focus();
      });

      addForm.addEventListener("submit", async (ev) => {
        ev.preventDefault();
        if (!pendingLatLng) return;

        const payload = {
          name: fName.value.trim(),
          type: fType.value,
          site: fSite.value.trim() || null,
          notes: fNotes.value.trim() || null,
          latitude: pendingLatLng.lat,
          longitude: pendingLatLng.lng,
        };

        const { error } = await supabase.from("locations").insert(payload);
        if (error) {
          alert("Erreur insert: " + error.message);
          return;
        }

        addDialog.close();
        pendingLatLng = null;
        await loadLocations();
      });

      // initial load
      await loadLocations();
    </script>
  </body>
</html>
