<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />
    <link rel="stylesheet" href="./styles.css" />
  </head>

  <body>
    <header class="topbar">
      <div class="brand">Livraison</div>
      <div class="muted">Admin</div>
      <div style="flex:1"></div>
      <button id="logoutBtn">Déconnexion</button>
    </header>

  <main class="container" style="max-width: 1200px;">
  <div class="admin-layout">
    <div class="card">
      <div style="display:flex; align-items:center; gap:10px;">
        <h2 style="margin:0;">Admin</h2>
        <div id="who" class="muted" style="font-size:12px;"></div>
        <div style="flex:1"></div>
        <button id="reloadBtn" class="smallbtn" type="button">↻ Recharger</button>
      </div>

      <div class="muted" style="font-size:12px; margin-top:8px;">
        Pins = lieux (locations). Détails = machines.
      </div>

      <div id="err" class="err" style="margin-top:10px;"></div>

      <div id="map" style="height: 72vh; margin-top: 12px; border-radius: 12px; overflow:hidden;"></div>
    </div>

    <aside class="card" style="height: calc(72vh + 64px); overflow:auto;">
      <div style="display:flex; align-items:center; gap:8px;">
        <strong>Lieux & machines</strong>
        <div style="flex:1"></div>
        <span id="countBox" class="muted" style="font-size:12px;"></span>
      </div>

      <div class="spacer"></div>

      <!-- Filtres -->
      <div class="grid" style="grid-template-columns: 1fr 1fr; gap:10px;">
        <label class="field">
          <div class="label">Type machine</div>
          <select id="filterKind">
            <option value="">Tous</option>
            <option value="sandwich">sandwich</option>
            <option value="snack">snack</option>
            <option value="boisson">boisson</option>
            <option value="cafe">cafe</option>
            <option value="autre">autre</option>
          </select>
        </label>

        <label class="field">
          <div class="label">Statut</div>
          <select id="filterStatus">
            <option value="">Tous</option>
            <option value="ok">ok</option>
            <option value="panne">panne</option>
            <option value="vide">vide</option>
            <option value="a_verifier">a_verifier</option>
          </select>
        </label>

        <label class="field" style="grid-column: 1 / -1;">
          <div class="label">Recherche lieu</div>
          <input id="filterText" placeholder="Avia, LGG, bâtiment 44…" />
        </label>
      </div>

      <div class="spacer"></div>

      <!-- Liste -->
      <div id="listBox"></div>
    </aside>
  </div>
</main>



    <!-- ✅ 1) LE DIALOG = HTML (donc ici, dans le body, hors script) -->
    <dialog id="addDialog">
      <form id="addForm" class="grid" style="margin:0;">
        <h3 style="margin:0 0 6px 0;">Nouveau lieu</h3>
        <div class="muted" style="font-size:12px;">Coordonnées : <span id="coordsText">—</span></div>

        <label class="field">
          <div class="label">Nom</div>
          <input id="fName" required placeholder="Ex: Machine sandwich Avia Partner" />
        </label>

        <label class="field">
          <div class="label">Type</div>
          <select id="fType">
            <option value="sandwich">sandwich</option>
            <option value="snack">snack</option>
            <option value="autre">autre</option>
          </select>
        </label>

        <label class="field">
          <div class="label">Site</div>
          <input id="fSite" placeholder="Ex: Aéroport LGG / Avia" />
        </label>

        <label class="field">
          <div class="label">Notes</div>
          <textarea id="fNotes" placeholder="Badge, accès, horaires…"></textarea>
        </label>

        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
          <button id="cancelBtn" type="button" class="smallbtn">Annuler</button>
          <button type="submit" class="smallbtn">Enregistrer</button>
        </div>
      </form>
    </dialog>

    <!-- Config -->
    <script src="./config.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <script type="module">
  // -----------------------------
  // Helpers UI
  // -----------------------------
  const errBox = document.getElementById("err");
  const whoBox = document.getElementById("who");
  const reloadBtn = document.getElementById("reloadBtn");

  const listBox = document.getElementById("listBox");
  const countBox = document.getElementById("countBox");
  const filterKind = document.getElementById("filterKind");
  const filterStatus = document.getElementById("filterStatus");
  const filterText = document.getElementById("filterText");

  function setErr(msg) {
    errBox.textContent = msg || "";
  }

  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // -----------------------------
  // Init Supabase
  // -----------------------------
  const supabase = window.supabase.createClient(
    window.APP_CONFIG.SUPABASE_URL,
    window.APP_CONFIG.SUPABASE_ANON_KEY
  );

  // -----------------------------
  // Auth guard
  // -----------------------------
  const { data: auth } = await supabase.auth.getUser();
  if (!auth?.user) {
    window.location.href = "./index.html";
  } else {
    whoBox.textContent = auth.user.email ? `Connecté : ${auth.user.email}` : "";
  }

  const { data: profile, error: profileErr } = await supabase
    .from("profiles")
    .select("role")
    .eq("user_id", auth.user.id)
    .single();

  if (profileErr) {
    setErr("Erreur profile: " + profileErr.message);
  } else if (profile?.role !== "admin") {
    window.location.href = "./driver.html";
  }

  // -----------------------------
  // Logout
  // -----------------------------
  document.getElementById("logoutBtn").onclick = async () => {
    await supabase.auth.signOut();
    window.location.href = "./index.html";
  };

  // -----------------------------
  // Leaflet map
  // -----------------------------
  const map = L.map("map").setView([50.631, 5.571], 12);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors",
  }).addTo(map);

  // -----------------------------
  // State
  // -----------------------------
  let markers = [];
  let allLocations = [];
  let allMachines = [];
  let markerByLocationId = new Map();

  // dialog state
  let pendingLatLng = null;
  let editingLocationId = null;

  // -----------------------------
  // Dialog elements
  // -----------------------------
  const addDialog = document.getElementById("addDialog");
  const addForm = document.getElementById("addForm");
  const cancelBtn = document.getElementById("cancelBtn");

  const fName = document.getElementById("fName");
  const fType = document.getElementById("fType");
  const fSite = document.getElementById("fSite");
  const fNotes = document.getElementById("fNotes");
  const coordsText = document.getElementById("coordsText");

  cancelBtn.onclick = () => addDialog.close();

  // -----------------------------
  // Render markers
  // -----------------------------
  function renderLocations(locations) {
    // clear markers
    markers.forEach((m) => map.removeLayer(m));
    markers = [];
    markerByLocationId.clear();

    locations.forEach((loc) => {
      if (loc.latitude == null || loc.longitude == null) return;

      const marker = L.marker([loc.latitude, loc.longitude]).addTo(map);

      marker.bindPopup(`
        <div style="font-weight:900;">${escapeHtml(loc.name)}</div>
        <div style="opacity:.75; font-size:12px; margin-bottom:8px;">
          ${escapeHtml(loc.type)} ${loc.site ? "— " + escapeHtml(loc.site) : ""}
        </div>
        <div style="display:flex; gap:8px;">
          <button onclick="window.editLocation('${loc.id}')">Modifier</button>
          <button onclick="window.deleteLocation('${loc.id}')" style="color:#ff6b6b;">Supprimer</button>
        </div>
      `);

      markers.push(marker);
      markerByLocationId.set(loc.id, marker);
    });
  }

  // -----------------------------
  // Load data
  // -----------------------------
  async function loadLocations() {
    setErr("");

    const { data, error } = await supabase
      .from("locations")
      .select("*")
      .order("created_at", { ascending: false });

    if (error) {
      console.error(error);
      setErr("Erreur chargement locations: " + error.message);
      return;
    }

    allLocations = data || [];
    renderLocations(allLocations);
  }

  async function loadMachines() {
    const { data, error } = await supabase
      .from("machines")
      .select("*")
      .order("created_at", { ascending: false });

    if (error) {
      console.error(error);
      setErr("Erreur chargement machines: " + error.message);
      return;
    }

    allMachines = data || [];
  }

  // -----------------------------
  // List / Filters
  // -----------------------------
  function buildMachinesByLoc(machines) {
    const map = new Map();
    for (const m of machines) {
      if (!map.has(m.location_id)) map.set(m.location_id, []);
      map.get(m.location_id).push(m);
    }
    return map;
  }

  function applyFilters() {
    const k = (filterKind.value || "").trim();
    const s = (filterStatus.value || "").trim();
    const q = (filterText.value || "").toLowerCase().trim();

    const filteredMachines = allMachines.filter((m) => {
      if (k && m.kind !== k) return false;
      if (s && m.status !== s) return false;
      return true;
    });

    const machinesByLoc = buildMachinesByLoc(filteredMachines);
    const hasMachineFilter = !!k || !!s;

    const filteredLocations = allLocations.filter((loc) => {
      const textOk =
        !q ||
        (loc.name || "").toLowerCase().includes(q) ||
        (loc.site || "").toLowerCase().includes(q);

      if (!textOk) return false;

      if (!hasMachineFilter) return true;
      return (machinesByLoc.get(loc.id) || []).length > 0;
    });

    renderList(filteredLocations, machinesByLoc, hasMachineFilter);
  }

  function renderList(locations, machinesByLoc, hasMachineFilter) {
    listBox.innerHTML = "";

    let totalMachinesShown = 0;

    for (const loc of locations) {
      const ms = hasMachineFilter
        ? machinesByLoc.get(loc.id) || []
        : allMachines.filter((m) => m.location_id === loc.id);

      totalMachinesShown += ms.length;

      const el = document.createElement("div");
      el.className = "locCard";

      el.innerHTML = `
        <div class="locTitle">
          <div>
            <button class="btnLink" data-loc="${loc.id}">
              <strong>${escapeHtml(loc.name || "Sans nom")}</strong>
            </button>
            <div class="muted" style="font-size:12px;">
              ${escapeHtml(loc.site || "")}
            </div>
          </div>
          <span class="badge">${ms.length} machine(s)</span>
        </div>
        <div class="machinesBox"></div>
      `;

      el.querySelector("[data-loc]").addEventListener("click", () => {
        if (loc.latitude != null && loc.longitude != null) {
          map.setView([loc.latitude, loc.longitude], 15);
        }
        const marker = markerByLocationId.get(loc.id);
        if (marker) marker.openPopup();
      });

      const box = el.querySelector(".machinesBox");

      if (!ms.length) {
        const empty = document.createElement("div");
        empty.className = "muted";
        empty.style.fontSize = "12px";
        empty.style.marginTop = "8px";
        empty.textContent = "Aucune machine";
        box.appendChild(empty);
      } else {
        for (const m of ms) {
          const row = document.createElement("div");
          row.className = "machineRow";
          row.innerHTML = `
            <div>
              <div><strong>${escapeHtml(m.label || "")}</strong></div>
              <div class="muted" style="font-size:12px;">
                ${escapeHtml(m.kind)} • ${escapeHtml(m.status)}
              </div>
            </div>
            <div class="muted" style="font-size:12px;">
              ${m.notes ? escapeHtml(m.notes) : ""}
            </div>
          `;
          box.appendChild(row);
        }
      }

      listBox.appendChild(el);
    }

    countBox.textContent = `${locations.length} lieu(x) • ${totalMachinesShown} machine(s)`;
  }

  filterKind.onchange = applyFilters;
  filterStatus.onchange = applyFilters;
  filterText.oninput = applyFilters;

  // -----------------------------
  // Click map -> open dialog (create)
  // -----------------------------
  map.on("click", (e) => {
    if (e.originalEvent?.target?.closest?.(".leaflet-marker-icon")) return;

    editingLocationId = null;
    pendingLatLng = e.latlng;

    coordsText.textContent = `${pendingLatLng.lat.toFixed(6)}, ${pendingLatLng.lng.toFixed(6)}`;

    fName.value = "";
    fType.value = "sandwich";
    fSite.value = "";
    fNotes.value = "";

    addDialog.showModal();
    fName.focus();
  });

  // submit dialog
  addForm.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    if (!pendingLatLng) return;

    const payload = {
      name: fName.value.trim(),
      type: fType.value,
      site: fSite.value.trim() || null,
      notes: fNotes.value.trim() || null,
      latitude: pendingLatLng.lat,
      longitude: pendingLatLng.lng,
    };

    let res;
    if (editingLocationId) {
      res = await supabase.from("locations").update(payload).eq("id", editingLocationId);
    } else {
      res = await supabase.from("locations").insert(payload);
    }

    if (res.error) {
      alert("Erreur: " + res.error.message);
      return;
    }

    addDialog.close();
    pendingLatLng = null;
    editingLocationId = null;

    await refreshAll();
  });

  // -----------------------------
  // Edit / Delete exposed to popup buttons
  // -----------------------------
  window.editLocation = async (id) => {
    setErr("");

    const { data, error } = await supabase
      .from("locations")
      .select("*")
      .eq("id", id)
      .single();

    if (error) return alert("Erreur chargement: " + error.message);

    editingLocationId = id;
    pendingLatLng = { lat: data.latitude, lng: data.longitude };

    coordsText.textContent = `${pendingLatLng.lat.toFixed(6)}, ${pendingLatLng.lng.toFixed(6)}`;

    fName.value = data.name || "";
    fType.value = data.type || "sandwich";
    fSite.value = data.site || "";
    fNotes.value = data.notes || "";

    addDialog.showModal();
    fName.focus();
  };

  window.deleteLocation = async (id) => {
    if (!confirm("Supprimer ce lieu ?")) return;

    const { error } = await supabase.from("locations").delete().eq("id", id);
    if (error) return alert("Erreur suppression: " + error.message);

    await refreshAll();
  };

  // -----------------------------
  // Refresh all
  // -----------------------------
  async function refreshAll() {
    await loadLocations();
    await loadMachines();
    applyFilters();
  }

  reloadBtn.onclick = refreshAll;

  // initial load
  await refreshAll();
</script>
  </body>
</html>
